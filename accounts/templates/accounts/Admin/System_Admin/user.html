{% extends "accounts/Admin/System_Admin/admin_home.html" %}


{% load static %}
{% block user %}



<div class="container-fluid">
    <div class="container">
        <i class="fas fa-user-friends two-user-icon"></i> 
        <h1 class="user">USERS</h1>
    </div>
    <div class="search">
        <input class="form-control mb-3" type="text" placeholder="Search..." id="search_bar_request" oninput="filterTable()">
    </div>
    

   
    <form action="" method="POST">
        {% csrf_token %}
                <div class="usertable table-responsive">
                    
                    <table id="myTable" class="usertable">
                        <thead>

                            <tr>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">CTU ID</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">FIRST NAME</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">LAST NAME</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">EMAIL</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">CONTACT NO. 1</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">CONTACT NO. 2</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">ROLE</th>
                                <th class="text-center text-nowrap" style="min-width: 13rem;">ACTION</th>
                            </tr>

                        </thead>

                        <tbody>

                            
                            {% for user in users %}
                            <tr id="user_row_{{ user.id }}" class="user-row">
                                <td class="user_username text-center">
                                    <span class="editable">{{ user.username }}</span>
                                    <input type="text" class="edit-input" name="username" value="{{ user.username }}" style="display: none;">
                                </td>
                                <td class="user_first_name text-center">
                                    <span class="editable">{{ user.first_name }}</span>
                                    <input type="text" class="edit-input" name="first_name" value="{{ user.first_name }}" style="display: none;">
                                </td>
                                <td class="user_last_name text-center">
                                    <span class="editable">{{ user.last_name }}</span>
                                    <input type="text" class="edit-input" name="last_name" value="{{ user.last_name }}" style="display: none;">
                                </td>
                                <td class="user_email text-center">
                                    <span class="editable">{{ user.email }}</span>
                                    <input type="text" class="edit-input" name="email" value="{{ user.email }}" style="display: none;">
                                </td>
                                <td class="user_contact1 text-center">
                                    <span class="editable">{{ user.contact1 }}</span>
                                    <input type="text" class="edit-input" name="contact1" value="{{ user.contact1 }}" style="display: none;">
                                </td>
                                <td class="user_contact2 text-center">
                                    <span class="editable">{{ user.contact2 }}</span>
                                    <input type="text" class="edit-input" name="contact2" value="{{ user.contact2}}" style="display: none;">
                                </td>
                                <td class="user_usertype text-center">
                                    <span class="editable">{{ user.get_user_type_display }}</span>
                                    <input type="text" class="edit-input" name="user_type" value="{{ user.get_user_type_display }}" style="display: none;">
                                </td>
                                <td>
                                    <button type="button" class="btn btn-primary edit-icon" onclick="editUser('user_row_{{ user.id }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                        <div>
                                            <button class="btn btn-success save-icon" style="display: none;">
                                            Save
                                            </button>
                                            <button class="btn btn-danger cancel-icon" style="display: none;"> 
                                                Cancel
                                            </button>
                                        </div>
                                    <button type="button" class="btn btn-primary edit-icon" onclick="deleteUser('user_row_{{ user.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>

                                </td>
                            </tr>
                            
                            {% endfor %}

                        </tbody>

                        
                    </table>
                </div>
  

    </form>

    


</div>



<script>

    var editButtons = document.querySelectorAll('.edit-icon');
    editButtons.forEach(function(editIcon) {
        editIcon.addEventListener('click', function(event) {
            var currentRow = event.currentTarget.closest('.user-row');
            editUser(currentRow);
        });
    });


    function editUser(userId) {
        var row = document.getElementById(userId);

        var editIcon = row.querySelector('.edit-icon');
        var saveButton = row.querySelector('.save-icon');
        var cancelButton = row.querySelector('.cancel-icon');
        var editInputs = row.querySelectorAll('.edit-input');
        var editableSpans = row.querySelectorAll('.editable');

        editIcon.style.display = 'none';
        saveButton.style.display = 'inline-block'; 
        cancelButton.style.display = 'inline-block'; 

  
        editInputs.forEach(function(input) {
            input.style.display = 'block'; 
        });

        editableSpans.forEach(function(span) {
            span.style.display = 'none';  
        });

        
        cancelButton.addEventListener('click', function() {
           
            editIcon.style.display = 'inline-block'; 
            saveButton.style.display = 'none';
            cancelButton.style.display = 'none';

            editInputs.forEach(function(input) {
                input.style.display = 'none';
            });
            editableSpans.forEach(function(span) {
                span.style.display = 'inline-block';  
            });
        });

        
        saveButton.addEventListener('click', function() {
            var formData = new FormData();
            var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            formData.append('csrfmiddlewaretoken', csrfToken);

            editInputs.forEach(function(input) {
                formData.append(input.name, input.value);
            });

            fetch('/update_user/{{ user.id }}/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok.');
                }
            })
            .then(data => {
                if (data.success) {
                    
                    editableSpans.forEach(function(span, index) {
                        span.textContent = editInputs[index].value;
                        span.style.display = 'inline-block';
                        editInputs[index].style.display = 'none';
                    });

                    saveButton.style.display = 'none';
                    cancelButton.style.display = 'none';
                } else {
                    
                    console.error('Error updating user:', data.errors);
                    
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                
            });
        });
    }

    function deleteUser(userId) {
        if (confirm("Are you sure you want to delete this user?")) {
        fetch(`/delete_user/${userId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => {
            if (response.ok) {
               
                console.log('User deleted successfully');
                
                window.location.reload(); 
                
            } else {
                throw new Error('Failed to delete user');
            }
        })
        .catch(error => {
            console.error('There was a problem deleting the user:', error);
            
        });
    }
}

    


</script>



{% endblock %}
{% block admin_home %}
{% endblock %}