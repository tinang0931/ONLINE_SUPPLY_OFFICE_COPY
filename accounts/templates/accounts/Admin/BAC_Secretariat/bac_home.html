{% extends "accounts/Admin/BAC_Secretariat/bac.html" %}

{% load static %}

{% block bac_home %}

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<style>
 
  .status {
    width: 15%;
    text-align: center;
  }

  .table a {
    text-decoration: none;
    color: black;
  }

  .bg-success {
    background-color: #9ee800;
    color: white;
  }
  .table {
    width: 90%; 
    margin: auto; 
    table-layout: fixed; 
    position: fixed; 
  }

  .table th, .table td {
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }

  .table th:nth-child(1),
  .table td:nth-child(1) {
    width: 15%;
  }

  .table th:nth-child(2),
  .table td:nth-child(2) {
    width: 25%;
  }

  .table th:nth-child(3),
  .table td:nth-child(3) {
    width: 20%;
  }

  .table th:nth-child(4),
  .table td:nth-child(4) {
    width: 15%;
  }

  .table th:nth-child(5),
  .table td:nth-child(5) {
    width: 25%;
  }

  .form-control {
    display: block;
    width: 18%;
    padding: .375rem .75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: var(--bs-body-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: rgb(13 110 253 / 8%);
    background-clip: padding-box;
    border: var(--bs-border-width) solid #343a40;
    border-radius: var(--bs-border-radius);
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    margin-left: 1300px;
    z-index: 1000; 
  }

  .btn-outline-success {
    color: #ffffff; 
    background-color: #2d83da; 
    border-color: #000;
    margin-left: 1680px;
    height: 35px;
  }

  .btn-outline-success:hover {
    color: #ffffff; 
    background-color: rgb(9, 66, 222); 
    border-color: #082fdc; 
  }

  .search-form {
    justify-content: flex-end;
  }

</style>

<div class="container-fluid" style="height: 68vh; overflow-y: auto; overflow-x: hidden;">
  <h1 class="pr text-center pt-4">PURCHASE REQUESTS</h1>

  <div class="search">
  <input class="form-control mb-3" type="text" placeholder="First name, Last name, Department" id="search_bar_request" oninput="filterTable()">
</div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th class="text-center" onclick="sortTable(0)" style="width: 15%;">
          Date Requested
          <span class="sort-arrow">
            <span class="sort-arrow-up"></span>
            <span class="sort-arrow-down"></span>
          </span>
        </th>
        <th class="text-center" onclick="sortTable(1)" style="width: 25%;">
          Requests
          <span class="sort-arrow">
            <span class="sort-arrow-up"></span>
            <span class="sort-arrow-down"></span>
          </span>
        </th>
        <th class="text-center" onclick="sortTable(2)" style="width: 20%;">
          Purpose
          <span class="sort-arrow">
            <span class="sort-arrow-up"></span>
            <span class="sort-arrow-down"></span>
          </span>
        </th>
        <th class="status" onclick="sortTable(3)" style="width: 15%;">
          Status
          <span class="sort-arrow">
            <span class="sort-arrow-up"></span>
            <span class="sort-arrow-down"></span>
          </span>
        </th>
        <th class="text-center" onclick="sortTable(4)" style="width: 25%;">
          Date
          <span class="sort-arrow">
            <span class="sort-arrow-up"></span>
            <span class="sort-arrow-down"></span>
          </span>
        </th>
      </tr>
    </thead>
    
    <tbody>
      {% for checkout in checkouts %}
        <tr>
          <td class="text-center" style="width: 15%;">{{ checkout.submission_date }}</td>
          <td style="width: 25%;">
            <a href="{% url 'preqform' pr_id=checkout.pr_id %}">
              <strong>{{ checkout.first_name }} {{ checkout.last_name }}</strong>
            </a>
            submitted a new purchase request on {{ checkout.submission_date }}
          </td>
          <td style="width: 20%;">{{ checkout.purpose }}</td>
          <td class="badge {% if checkout.status_comment %}bg-success{% else %}no-comment{% endif %}" style="width: 15%; margin-top: 5px; margin-left: 5px; color: white;">
            {% if checkout.status_comment %}
              {{ checkout.status_comment }}
            {% else %}
              &nbsp; 
            {% endif %}
          </td>
          <td style="width: 25%;">
            {% if checkout.status_update_date %}{{ checkout.status_update_date }}{% else %}&nbsp;{% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
    
    
    
  </table>

 <script>
  const defaultSortDirections = [1, 1, 1, 1, 1]; 
  let currentColumn = 0; 
  let originalRows; 

  window.addEventListener('DOMContentLoaded', () => {
    originalRows = Array.from(document.querySelector('.table').querySelectorAll('tbody tr'));
    filterAndSortTable('', currentColumn);
  });

  function filterAndSortTable(searchText, sortColumn) {
    let table = document.querySelector('.table');
    let rows = originalRows ? [...originalRows] : Array.from(table.querySelectorAll('tbody tr'));

    if (searchText.trim() !== '') {
      rows = rows.filter(row => {
        let textContent = Array.from(row.getElementsByTagName('td')).map(td => td.innerText).join(' ').toLowerCase();
        return textContent.includes(searchText.toLowerCase());
      });
    }

    sortRows(rows, sortColumn);

    table.querySelector('tbody').innerHTML = '';
    rows.forEach(row => table.querySelector('tbody').appendChild(row));

    if (rows.length === 0) {
      originalRows.forEach(row => table.querySelector('tbody').appendChild(row));
    }
  }

  function sortRows(rows, sortColumn) {
    rows.sort((a, b) => {
      let aValue, bValue;

      if (sortColumn === 1) {
        aValue = a.getElementsByTagName('td')[sortColumn].innerText.trim().toLowerCase();
        bValue = b.getElementsByTagName('td')[sortColumn].innerText.trim().toLowerCase();
      } else {
        aValue = a.getElementsByTagName('td')[sortColumn].innerText.trim();
        bValue = b.getElementsByTagName('td')[sortColumn].innerText.trim();
      }

      return defaultSortDirections[sortColumn] * aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' });
    });

    resetArrows();
    let arrowUp = document.querySelectorAll('.sort-arrow-up')[sortColumn];
    arrowUp.innerHTML = '▲';
    let arrowDown = document.querySelectorAll('.sort-arrow-down')[sortColumn];
    arrowDown.innerHTML = '▼';

    defaultSortDirections[sortColumn] = defaultSortDirections[sortColumn] * -1;
    currentColumn = sortColumn;
  }

  function resetArrows() {
    document.querySelectorAll('.sort-arrow-up').forEach(arrow => arrow.innerHTML = '');
    document.querySelectorAll('.sort-arrow-down').forEach(arrow => arrow.innerHTML = '');
  }

  function filterTable() {
    let searchText = document.getElementById('search_bar_request').value;
    filterAndSortTable(searchText, currentColumn);
  }

  function sortTable(column) {
    filterAndSortTable('', column);
  }
</script>

  
  {% endblock %}
</div>