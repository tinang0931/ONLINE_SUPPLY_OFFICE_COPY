{% extends "accounts/Admin/BAC_Secretariat/nav.html" %} 
{% load static %} 
{%block request %}

<style>
  .table-bordered th {
    background-color: #003566;
    color: white;
  }

  .ctu_logo {
    position: relative;
    top: 10px;
    z-index: 1;
    left: -23px;
  }
  .head {
    color: white;
    font-family: "Gill Sans", "Gill Sans MT", "Calibri", "Trebuchet MS",
      sans-serif;
    margin-left: -20%;
    font-size: 48px;
  }

  .welcome {
    margin-left: 0;
  }

  .table-bordered {
    max-height: 700px;
    overflow-y: auto;
    margin-bottom: 20px;
  }

  @media only screen and (max-width: 768px) {
    .table-bordered {
      max-height: 400px;
    }
  }

  .table-responsive {
    margin-top: -6vh;
  }

  .popup-container {
    display: none;
    position: fixed;
    top: 40%;
    left: 90%;
    transform: translate(-50%, -50%);
    width: 300px;
    padding: 15px;
    background-color: rgba(0, 0, 0, 0.8);
    border: 1px solid #888;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    z-index: 9999;
    /* Ensure the box is above other elements */
    color: white;
  }

  .popup-container::before {
    content: "";
    position: absolute;
    bottom: -20px;
    /* Adjust arrow's position */
    left: calc(60% - -55px);
    /* Adjust arrow's horizontal position */
    border-width: 10px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }

  .ml-3,
  .mx-3 {
    margin-left: 1rem !important;
    margin-top: -37px;
  }

  button {
    padding: 5px 10px;
    /* Adjusted padding */
    border: unset;
    border-radius: 15px;
    color: #212121;
    z-index: 1;
    background: #e8e8e8;
    position: relative;
    font-weight: 1000;
    font-size: 14px;
    /* Adjusted font size */
    -webkit-box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
    box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
    transition: all 250ms;
    overflow: hidden;
  }

  button::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    border-radius: 15px;
    background-color: #ffa500;
    z-index: -1;
    -webkit-box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
    box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
    transition: all 250ms;
  }

  button:hover {
    color: #e8e8e8;
    /* Change color to white when hovered */
  }

  button:hover::before {
    width: 100%;
  }
  .row {
    margin-top: 70px;
  }

  .navbar.bg-light {
    background-color: #003566 !important;
  }

  .bck {
    position: relative; /* Ensures the .bck element respects z-index */
    z-index: 100; /* Default stacking context */
  }

  .bck a {
    display: flex;
    align-items: center;
    text-decoration: none;
    z-index: 500; /* Higher than .bck */
  }

  .bck img {
    width: 50px;
    height: 50px;
    transition: transform 0.3s ease-in-out;
    position: fixed;
    top: 15vh;
    z-index: 999; /* Highest stacking context for the image */
  }

  .bck:hover img {
    transform: scale(1.2);
    z-index: 1000; /* Ensure the image comes forward when hovered */
  }
</style>

<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
/>
<link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
/>
<link rel="stylesheet" href="{% static 'css/request.css' %}" />

<div
  class="container-fluid"
  style="height: 82vh; overflow-y: auto; overflow-x: hidden"
>
  <div id="page-content-wrapper ">
    <nav class="bg-light"></nav>
  </div>

  <div class="container">
    <h1 style="margin-left: 45%; margin-top: 5vh"></h1>
  </div>
  <div class="home"></div>

  <div class="bck">
    <a href="{% url 'ppmp' %}">
      <img src="{% static 'images/back2.png' %}" alt="Previous" />
    </a>
  </div>

  <div class="row" style="width: 100%">
    <div
      class="search"
      style="
        position: relative;
        text-align: right;
        margin-top: -6vh;
        display: inline-block;
        width: 100%;
        top: -11px;
      "
    >
      <span
        class="icon"
        style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 40px;
          right: 28px;
          top: 22%;
        "
      >
      </span>
      <input
        class="form-control mb-3 pr-6 pl-6"
        type="text"
        placeholder="Search here"
        id="search_bar_request"
        style="
          border: 2px solid #003566;
          border-radius: 25px;
          padding-right: 40px;
          width: 300px;
          display: inline-block;
        "
        oninput="handleSearch()"
      />
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered custom-table" id="catalogue-table">
      <thead>
        <tr>
          <th>Item Name</th>
          <th>Brand / Description</th>
          <th>Unit</th>
          <th>Unit Price</th>
          <th>Select</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be dynamically inserted here -->
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <script>
    // Function to fetch catalogue data
    async function fetchCatalogueData() {
      try {
        const token = localStorage.getItem("accessToken"); // Retrieve the token from localStorage

        if (!token) {
          throw new Error("User is not logged in. Please log in.");
        }

        const apiUrl = "http://172.28.48.53:8000/api/ppmp101/"; // Replace with your API URL
        const response = await fetch(apiUrl, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });

        if (!response.ok) {
          throw new Error("Network response was not ok");
        }

        const data = await response.json();
        const groupedData = data.grouped_data; // Get the grouped data from the response

        const tableBody = document.querySelector("#catalogue-table tbody");
        tableBody.innerHTML = ""; // Clear the table before adding new rows

        // Iterate over the grouped data and populate the table
        for (const [category, items] of Object.entries(groupedData)) {
          // Add category row
          const categoryRow = document.createElement("tr");
          categoryRow.classList.add("category-row");
          categoryRow.innerHTML = `<th colspan="5">${category}</th>`;
          tableBody.appendChild(categoryRow);

          // Add item rows
          items.forEach((item) => {
            const itemRow = document.createElement("tr");
            itemRow.classList.add("item-row");
            itemRow.id = item.item_id;

            itemRow.innerHTML = `
                        <td class="text-left">
                            ${item.Item_name}
                            <input type="hidden" name="item" value="${item.Item_name}" />
                        </td>
                        <td class="text-left">
                            ${item.Item_Brand}
                            <input type="hidden" name="item_brand_description" value="${item.Item_Brand}" />
                        </td>
                        <td>
                            ${item.Unit}
                            <input type="hidden" name="unit" value="${item.Unit}" />
                        </td>
                        <td>
                            ${item.Price}
                            <input type="hidden" name="unit_cost" value="${item.Price}" />
                        </td>
                        <!-- Updated Button with FontAwesome icons -->
                        <td>
                            <button type="button" class="button add-to-cart" data-item-id="${item.item_id}" style="border-radius: 15px">
                                <i class="fas fa-shopping-cart cart-icon"></i>  <!-- Cart Icon -->
                            </button>
                        </td>

                    `;
            tableBody.appendChild(itemRow);
          });
        }

        // Add event listeners to the "Add to Cart" buttons
        const addToCartButtons = document.querySelectorAll(".add-to-cart");
        addToCartButtons.forEach((button) => {
          button.addEventListener("click", async function () {
            const itemId = button.getAttribute("data-item-id");
            const itemRow = button.closest("tr");
            const itemData = {
              item: itemRow.querySelector('input[name="item"]').value,
              item_brand_description: itemRow.querySelector(
                'input[name="item_brand_description"]'
              ).value,
              unit: itemRow.querySelector('input[name="unit"]').value,
              unit_cost: itemRow.querySelector('input[name="unit_cost"]').value,
            };

            try {
                const token = localStorage.getItem("accessToken"); // Ensure token is present
                const apiUrl = "http://172.28.48.53:8000/api/additems/"; // URL for adding to cart

                const response = await fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(itemData), // Send data to API
                });

                if (!response.ok) {
                throw new Error("Failed to add item to cart");
                }

                const result = await response.json();
                console.log("Item added to cart:", result);

                const cartIcon = button.querySelector('i');
                cartIcon.classList.remove('fas', 'fa-shopping-cart'); // Remove cart icon classes
                cartIcon.classList.add('fas', 'fa-check', 'text-success');  // Add checkmark icon with success color
                button.disabled = true;  
            } catch (error) {
              console.error("Error adding item to cart:", error);
            }
          });
        });
      } catch (error) {
        console.error("Failed to fetch data:", error);
      }
    }

    // Call the function to load data when the page loads
    document.addEventListener("DOMContentLoaded", fetchCatalogueData);

    $(document).ready(function () {
      function updateEstimateBudgetForRow(row) {
        var unitPrice = parseFloat(row.find('[name="price"]').val());

        var totalValue = 0;

        row
          .find(
            '[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]'
          )
          .each(function () {
            var monthValue = parseFloat($(this).val()) || 0;
            totalValue += monthValue;
          });

        var estimateBudget = totalValue * unitPrice;

        row.find('[name="estimate_budget"]').val(estimateBudget.toFixed(2));
      }

      $(
        '[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]'
      ).on("input", function () {
        var row = $(this).closest("tr.item-row");
        updateEstimateBudgetForRow(row);
      });

      $('[name="price"]').on("input", function () {
        var row = $(this).closest("tr.item-row");
        updateEstimateBudgetForRow(row);
      });
    });

    function scrollToCategory() {
      var selectedCategory =
        document.getElementById("dropdownMenuSelect").value;
      var table = document.getElementById(selectedCategory);
      if (table) {
        table.scrollIntoView({ behavior: "smooth" });
      }
    }

    function highlightInput(input) {
      input.select();
    }

    $(document).ready(function () {
      // Add click event to checkboxes
      $(".row-checkbox").on("click", function () {
        // Find the closest tr and toggle the 'selected' class
        $(this).closest("tr").toggleClass("selected");
      });
    });

    const categoryFilter = document.getElementById("category_filter");
    const productTables = document.querySelectorAll(".table table");

    categoryFilter.addEventListener("change", (event) => {
      const selectedCategory = event.target.value;
      const filteredProducts = {};

      if (selectedCategory !== "all") {
        for (const productTable of productTables) {
          const categoryName = productTable.querySelector("h3").textContent;
          if (categoryName === selectedCategory) {
            const products = productTable.querySelectorAll("tbody tr");
            for (const product of products) {
              const itemName =
                product.querySelector("td:nth-child(2)").textContent;
              const itemDescription =
                product.querySelector("td:nth-child(3)").textContent;
              const unit = product.querySelector("td:nth-child(4)").textContent;
              const price =
                product.querySelector("td:nth-child(5)").textContent;

              if (!filteredProducts[categoryName]) {
                filteredProducts[categoryName] = [];
              }

              filteredProducts[categoryName].push({
                itemName,
                itemDescription,
                unit,
                price,
              });
            }
          }
        }
      }

      // Update the displayed items based on the filtered products
      updateProductTables(filteredProducts);
    });

    function updateProductTables(filteredProducts) {
      for (const productTable of productTables) {
        productTable.querySelector("tbody").innerHTML = ""; // Clear existing items

        const categoryName = productTable.querySelector("h3").textContent;
        const products = filteredProducts[categoryName] || [];

        for (const product of products) {
          const row = document.createElement("tr");

          const itemNameCell = document.createElement("td");
          itemNameCell.textContent = product.itemName;
          row.appendChild(itemNameCell);

          const itemDescriptionCell = document.createElement("td");
          itemDescriptionCell.textContent = product.itemDescription;
          row.appendChild(itemDescriptionCell);

          const unitCell = document.createElement("td");
          unitCell.textContent = product.unit;
          row.appendChild(unitCell);

          const priceCell = document.createElement("td");
          priceCell.textContent = product.price;
          row.appendChild(priceCell);

          productTable.querySelector("tbody").appendChild(row);
        }
      }
    }

    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
    }
  </script>

  <script>
    function handleSearch() {
      var input, filter, table, tr, td, i, txtValue;
      input = document.getElementById("search_bar_request");
      filter = input.value.toUpperCase();
      table = document.querySelector(".table-bordered"); // Change to your specific table class
      tr = table.getElementsByTagName("tr");

      for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[0]; // Modify this index based on the column you want to search
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  {% endblock %}
</div>
