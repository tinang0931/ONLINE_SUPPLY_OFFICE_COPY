{% extends "accounts/Admin/BAC_Secretariat/nav.html" %}

{% load static %}

{% block ppmp %}

<style>
    h1 {
        color: #333;
        font-size: 24px;
        margin: 20px 0;
      }
      .container-fluid {
        margin-bottom: 0;
    }
    .ctu_logo {
        margin-top: -13%;
    }

    .table-bordered th {
        background-color: #1c96c5;
        color: #fff;
      }
      .table-bordered th,
      .table-bordered td {
          color: #000; 
    
      }
      .table-container {
        margin-top: 20vh; 
    }
    .item-actions {
        display: none;
    }

    tr:hover .item-actions {
        display: flex;
    }

    .btn {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 1vh;
        background: #144472;
        font-family: "Montserrat", sans-serif;
        box-shadow: 0px 6px 24px 0px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        cursor: pointer;
        border: none;
        margin-left: -107%;
        margin-top: 15%;
        padding: 10px 20px;
        font-size: 16px;
    }
    .submt {
        float: inline-end;
    }

   
    .catalogue {
        background: #1c96c5;
        padding: 5px 15px;
        color: white;
        text-decoration: none;
        margin-left: 0;
        border: none;
        border-radius: 5px;
        margin-top: 15%;
    }

    .custom:hover,
    .catalogue:hover,
    .submt:hover {
        transition: all ease .5s;
        background: #144472;
    }


    .custom:active,
    .catalogue:active,
    .submt:active {
        transform: translate(0em, 0.14em);
    }


    .bck {
        position: fixed;
        bottom: 50px;
        left: 0;
        border-radius: 10px;
        padding: 10px;
        z-index: 1;
        display: inline-block;
        margin-left: 10px;
    }
    
    .bck a {
        display: flex;
        align-items: center;
        text-decoration: none;
    }
    
    .bck img {
        width: 30px;
        height: 30px;
        transition: all 0.3s ease-in-out;
    }
    
    .bck:hover img {
        transform: translateX(-5px);
        filter: brightness(1.2);
    }
    
    .bck::before {
        content: "";
        position: absolute;
        top: -5px;
        right: 0;
        bottom: -5px;
        left: 0;
        border-radius: 20px;
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s ease-in-out;
    }
    
    .bck:hover::before {
        opacity: 1;
    }
    
    .custom-dropdown .btn::after{
        display:none;
    }
    
    .custom-dropdown .btn {
        position: fixed;
        top: 8vh; 
        right: 3vh; 
        z-index: 1000;
        background-color: #1c96c5;
        color: whitesmoke;
        border: none;
        transition: all 0.5s ease;
        text-align: center;
        padding: 5px 10px;
        padding-right: 30px;
        width: 120px;
    }

    .dropdown-menu .dropdown-item:hover {
        background-color: #1c96c5;
        color: whitesmoke; 
    }
    .custom-dropdown .btn:hover {
        background-color: #1c96c5;
    }
</style>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">  
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'css/request.css' %}">


<div class="container-fluid" style="height: 82vh; overflow-y: auto; overflow-x: hidden; margin-bottom: 20px;">
    <div class="container">
        <h1 class="pr text-center pt-4">CREATE PROJECT PROCUREMENT MANAGEMENT PLAN(PPMP)</h1>
    </div>
    <div class="bck">
        <a href="{% url 'myppmp' %}">
            <img src="{% static 'images/previous_189252.png' %}" alt="Previous">
        </a>
    </div>
   

    <div class="bck">
        <a href="{% url 'myppmp' %}">
            <img src="{% static 'images/previous_189252.png' %}">
        </a>
    </div>

    <div class="row">
        <div class="col-md-1 mb-0">
            <button class="catalogue">
                <a href="{% url 'catalogue' %}" style="color: white; text-decoration: none;">Catalogue </a>
            </button>
        </div>
    </div>
    <div class="custom-dropdown mx-auto">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="yearDropdown" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
            Select Year
        </button>
        <div class="dropdown-menu text-center" aria-labelledby="yearDropdown">
            <a class="dropdown-item" href="#" data-year="2022">2022</a>
            <a class="dropdown-item" href="#" data-year="2023">2023</a>
            <a class="dropdown-item" href="#" data-year="2024">2024</a>
            <a class="dropdown-item" href="#" data-year="2025">2025</a>
            <a class="dropdown-item" href="#" data-year="2026">2026</a>
            <a class="dropdown-item" href="#" data-year="2027">2027</a>
            <a class="dropdown-item" href="#" data-year="2028">2028</a>
            <a class="dropdown-item" href="#" data-year="2029">2029</a>
            <a class="dropdown-item" href="#" data-year="2030">2030</a>
        </div>
    </div>
    
    <div class="row">
        <div class="text-left">
            <h5><strong> TOTAL ALLOCATED BUDGET : 1,000,000 </strong></h5>
        </div>
        <div class="text-center">
            <label for="estimate_budget"><strong>TOTAL AMOUNT :</strong></label>
            <input type="number" name="estimate_budget" id="estimate_budget" readonly>
        </div>
    </div>
    


    <div class="table-responsive">

        <form action="{% url 'ppmp' %}" method="post">
            {% csrf_token %}
    
            <table class="table table-bordered text-center mt-4">
                <thead>
                    <tr>
                        <th rowspan='2' class="text-center">Item Name</th>
                        <th rowspan='2' class="text-center">Brand / Description</th>
                        <th rowspan='2' class="text-center">Unit</th>
                        <th rowspan='2' class="text-center">Estimated Budget</th>
                        <th colspan="12" class="text-center">Monthly Quantity Requirement</th>
                        <th rowspan='2' class="text-center">Unit Price</th>
                        <th rowspan="2" class="text-center">Action</th>
                    </tr>
                    <tr>
                        <th>Jan</th>
                        <th>Feb</th>
                        <th>Mar</th>
                        <th>April</th>
                        <th>May</th>
                        <th>June</th>
                        <th>July</th>
                        <th>Aug</th>
                        <th>Sept</th>
                        <th>Oct</th>
                        <th>Nov</th>
                        <th>Dec</th>
                    </tr>
                </thead>
                <tbody>
                <tbody>
                    {% for p in items %}

                    
                        <tr class="item-row" id="{{ p.id }}">

                            <td>
                                <span class="editable" data-field="Item_name">{{ p.item }}</span>
                                <input id="item_{{ p.id }}" name="item" type="text" value="{{ p.item }}"
                                    oninput="change_val('item_{{ p.id }}')" class="edit-input" style="display: none">
                            </td>
                            <td>
                                <span class="editable" data-field="Item_Brand">{{ p.item_brand_description }}</span>
                                <input id="item_brand_{{ p.id }}" name="item_brand" type="text" value="{{ p.item_brand_description }}"
                                    oninput="change_val('item_brand_{{ p.id }}')" class="edit-input"
                                    style="display: none">
                            </td>
                            <td>
                                <span class="editable" data-field="Unit">{{ p.unit }}</span>
                                <input id="unit_{{ p.id }}" name="unit" type="text" value="{{ p.unit }}"
                                    oninput="change_val('unit_{{ p.id }}')" class="edit-input" style="display: none">
                            </td>


                            <td><input type="number" name="estimate_budget"></td>

                            <td><input type="number"  style="width: 38px;" name="jan"></td>
                            <td><input type="number" style="width: 38px;" name="feb"></td>
                            <td><input type="number" style="width: 38px;" name="mar"></td>
                            <td><input type="number" style="width: 38px;" name="apr"></td>
                            <td><input type="number" style="width: 38px;" name="may"></td>
                            <td><input type="number" style="width: 38px;" name="jun"></td>
                            <td><input type="number" style="width: 38px;" name="jul"></td>
                            <td><input type="number" style="width: 38px;" name="aug"></td>
                            <td><input type="number" style="width: 38px;" name="sep"></td>
                            <td><input type="number" style="width: 38px;" name="oct"></td>
                            <td><input type="number" style="width: 38px;" name="nov"></td>
                            <td><input type="number" style="width: 38px;" name="dec"></td>

                            <td>
                                <span class="editable" data-field="Price">{{ p.unit_cost }}</span>
                                <input id="price_{{ p.id }}" name="price" type="number" value="{{ p.unit_cost }}"
                                    oninput="change_val('price_{{ p.id }}')" class="edit-input" style="display: none">
                            </td>



                            <td>
                                <div class="item-actions" style="text-align: center; gap: 20px">
                                    <a href="#" class="edit-icon" style="text-align: center;" onclick="editItem('{{ p.id }}')">
                                        <i class="fas fa-pencil-alt text-primary"></i>
                                    </a>


                                    <!-- <form action="{% url 'update' p.id %}" method="post">

                                        {% csrf_token %}
                                        <input id="form_item_{{ p.id }}" type="hidden" name="item_{{ p.id }}"
                                            value="{{ p.item }}">
                                        <input id="form_item_brand_{{ p.id }}" type="hidden"
                                            name="item_brand_{{ p.id }}" value="{{ p.item_brand_description }}">
                                        <input id="form_unit_{{ p.id }}" type="hidden" name="unit_{{ p.id }}"
                                            value="{{ p.unit }}">
                                        <input id="form_price_{{ p.id }}" type="number" style="display: none;"
                                            name="price_{{ p.id }}" value="{{ p.unit_cost }}">

                                        <button type="submit" class="save-icon" style="display: none;"><i
                                                class="fas fa-check text-success"></i></button>
                                        <button type="button" class="cancel-icon" style="display: none;"><i
                                                class="fas fa-times text-danger"></i></button>

                                    </form> -->



                                    {% if p.id %}
                                    <a href="{% url 'delete' p.id %}" class="delete-icon">
                                        <i class="fas fa-trash text-danger"></i>
                                    </a>
                                    {% endif %}

                                </div>
                            </td>


                        </tr>
                    {% endfor %}

                    <button type="submit" class="btn btn-success btn-sm m-2 float-right">
                        <i class="fas fa-check-circle"></i> Submit
                    </button>
                </form>

                <tr id="new-item-row-{{ category }}" style="display: none;">

                    <form method="post" action="{% url 'user_add_new_item' %}">
                      {% csrf_token %}
                      
                      <td>
                        <input type="text" name="new_item_name" placeholder="New Item Name" required>
                      </td>
                      <td>
                        <input type="text" name="new_item_brand" placeholder="New Item Brand/Description" required>
                      </td>
                      <td>
                        <input type="text" name="new_item_unit" placeholder="New Item Unit" required>
                      </td>
                      <td>
                        
                      </td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td>
                        <input type="number"  name="item_unit_price" placeholder="Item Unit Price">
                      </td>
                      <td>
                        <button type="submit" class="save-btn btn-success" style="background: none; border: none;" title="Save" onclick="saveFunction()">
                            <i class="fas fa-save" style="color: #28a745;"></i>
                        </button>
                      </td>
                    </form>
                  </tr>


                </tbody>
            </table>

            <button type="button" class="add-btn btn-primary btn-sm float-left mt-2 mb-2" id="add-btn-{{ category }}" onclick="toggleNewItemRow('{{ category }}')">
                <i class="fas fa-plus-circle"></i>
            </button>
            
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>

    function toggleNewItemRow(category) {
        var newRow = document.getElementById('new-item-row-' + category);
        newRow.style.display = newRow.style.display === 'none' ? 'table-row' : 'none';
      }

    function editItem(itemId) {
        // Assuming each row has a unique identifier, you can use it to target specific elements
        var row = document.getElementById(itemId);

        // Toggle visibility of elements
        var editIcon = row.querySelector('.edit-icon');
        var saveButton = row.querySelector('.save-icon');
        var cancelButton = row.querySelector('.cancel-icon');
        var editInputs = row.querySelectorAll('.edit-input');
        var editableSpans = row.querySelectorAll('.editable');

        // Show/hide elements
        editIcon.style.display = 'none';
        saveButton.style.display = 'inline-block';  // Adjust display style based on your styling
        cancelButton.style.display = 'inline-block';  // Adjust display style based on your styling

        // Show input fields for editing
        editInputs.forEach(function (input) {
            input.style.display = 'block';  // Adjust display style based on your styling
        });

        // Hide the spans displaying current values
        editableSpans.forEach(function (span) {
            span.style.display = 'none';  // Adjust display style based on your styling
        });

        // Add event listener to the cancel button
        cancelButton.addEventListener('click', function () {
            // Reset the form to its initial state
            editIcon.style.display = 'inline-block';  // Adjust display style based on your styling
            saveButton.style.display = 'none';
            cancelButton.style.display = 'none';
            editInputs.forEach(function (input) {
                input.style.display = 'none';
            });
            editableSpans.forEach(function (span) {
                span.style.display = 'inline-block';  // Adjust display style based on your styling
            });
        });

        // Trigger the form submission
        saveButton.addEventListener('click', function () {
            // Assuming you have a form element in the row
            var form = row.querySelector('form');
            form.submit();
        });
    }

    $(document).ready(function () {

        function updateEstimateBudgetForRow(row) {

            var unitPrice = parseFloat(row.find('[name="price"]').val());


            var totalValue = 0;


            row.find('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]').each(function () {
                var monthValue = parseFloat($(this).val()) || 0;
                totalValue += monthValue;
            });


            var estimateBudget = totalValue * unitPrice;


            row.find('[name="estimate_budget"]').val(estimateBudget.toFixed(2));
        }


        $('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]').on('input', function () {

            var row = $(this).closest('tr.item-row');
            updateEstimateBudgetForRow(row);
        });


        $('[name="price"]').on('input', function () {

            var row = $(this).closest('tr.item-row');
            updateEstimateBudgetForRow(row);
        });
    });

    function updateTotalForAllItems() {
    var totalValue = 0;

    $('tr.item-row').each(function() {
        var row = $(this);
        var unitPrice = parseFloat(row.find('[name="price"]').val());
        var rowTotalValue = 0;

        row.find('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]').each(function() {
            var monthValue = parseFloat($(this).val()) || 0;
            rowTotalValue += monthValue;
        });

        var rowTotal = rowTotalValue * unitPrice;
        totalValue += rowTotal;
    });

    var allocatedBudget = 90000; // Set your allocated budget here

    if (totalValue >= allocatedBudget) {
        alert('Budget limit reached! Further input is disabled.');

        $('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"], [name="price"]').prop('disabled', true);
    } else {

        $('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"], [name="price"]').prop('disabled', false);
    }

    $('#estimate_budget').val(totalValue.toFixed(2)); // Update the estimate_budget input field
}

$('[name^="jan"], [name^="feb"], [name^="mar"], [name^="apr"], [name^="may"], [name^="jun"], [name^="jul"], [name^="aug"], [name^="sep"], [name^="oct"], [name^="nov"], [name^="dec"]').on('input', function() {
    updateTotalForAllItems();
});

$('[name="price"]').on('input', function() {
    updateTotalForAllItems();
});

updateTotalForAllItems();
</script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    $(document).ready(function () {
        $('.dropdown-item').on('click', function (e) {
            e.stopPropagation(); 
            var selectedYear = $(this).text();
            updateButtonStyle(selectedYear);
            hideDropdown();
    });

    document.getElementById('yearDropdown').addEventListener('click', function() {
        this.style.backgroundColor = '#1c96c5';
    });

    function updateButtonStyle(selectedYear) {
            $('.dropdown-item').removeClass('selected');
            $('.dropdown-item[data-year="' + selectedYear + '"]').addClass('selected');
            $('.btn#yearDropdown').text(selectedYear).css('background-color', '#1c96c5');
            
        }

    function hideDropdown() {
        $('.custom-dropdown').removeClass('show');
        $('.custom-dropdown').find('.dropdown-toggle').attr('aria-expanded', 'false');
        $('.custom-dropdown').find('.dropdown-menu').removeClass('show');
    }
});
</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


{% endblock %}