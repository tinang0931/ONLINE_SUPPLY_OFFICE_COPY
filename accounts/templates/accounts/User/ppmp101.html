
{% extends "accounts/User/main2.html" %}
 
{% load static %}
 
{% block dashboard %}
 
<div class="dashboard">
    <div class="budget-section">
        <p class="budget-amount" id="budget-section"></p>
        <p class="budget-text">ANNUAL BUDGET</p>
    </div>
    <div class="ppmp-section">
        <p class="year">2024 PPMP</p>
    </div>
    <div class="ppmp-trackers-section">
      
        <h3>PPMP TRACKER</h3>
        <ul>
            <li><span class="green"></span> PPMP Request Sent - 09/01/24</li>
            <li><span class="green"></span> Approved by BO - 09/02/24</li>
            <li><span class="orange"></span> Waiting for CD Response - 09/02/24</li>
        </ul>
    </div>
    <div class="pr-trackers-section">
            <h3>PR TRACKER</h3>
            <ul>
                <li><span class="green"></span> PPMP Request Sent - 09/01/24</li>
                <li><span class="green"></span> Approved by BO - 09/02/24</li>
                <li><span class="orange"></span> Waiting for CD Response - 09/02/24</li>
            </ul>
    </div>
    <div class="left-container">
    <div class="catalogue-section">
        <h3>CATALOGUE</h3>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Brand/Description</th>
                    <th>Unit</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody id="catalogue-body">
                
            </tbody>
        </table>
    </div>
    </div>
 
        
</div>
<script>
   
    const fetchDashboardData = async () => {
        try {
            const token = localStorage.getItem('accessToken'); 

            if (!token) {
                throw new Error('User is not logged in. Please log in.');
            }

            const apiUrl = 'http://172.28.48.53:8000/api/ppmp101/'; 
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`, 
                },
            });


            const contentType = response.headers.get('Content-Type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Expected JSON response, but received something else.');
            }

            if (!response.ok) {
                throw new Error(`HTTP Error! Status: ${response.status}`);
            }

            const data = await response.json(); 

            if (data.user_budget && data.grouped_data) {
         
                const budgetSection = document.getElementById('budget-section');
                const formattedBudget = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(data.user_budget);
                budgetSection.textContent = formattedBudget;


                const catalogueBody = document.getElementById('catalogue-body');
                catalogueBody.innerHTML = ''; 

                for (const [category, items] of Object.entries(data.grouped_data)) {
                   
                    const categoryRow = document.createElement('tr');
                    categoryRow.innerHTML = `<th colspan="4">${category}</th>`;
                    catalogueBody.appendChild(categoryRow);

             
                    items.forEach((item) => {
                        const itemRow = document.createElement('tr');
                        itemRow.innerHTML = `
                            <td>${item.Item_name}</td>
                            <td>${item.Item_Brand}</td>
                            <td>${item.Unit}</td>
                            <td>${item.Price}</td>
                        `;
                        catalogueBody.appendChild(itemRow);
                    });
                }
            } else {
                throw new Error('Invalid data structure received from API.');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('Failed to fetch data. Please check the console for details.');
        }
    };

    document.addEventListener('DOMContentLoaded', fetchDashboardData);
</script>

{% endblock %}
