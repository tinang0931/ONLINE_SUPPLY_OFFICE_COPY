{% extends "accounts/User/main.html" %}

{% load static %}

{% block content %}
        <div class="container-fluid" style=" height: 68vh; overflow-y: auto; overflow-x: hidden; ">
          <div class="container">
            <h1 class="pr text-center pt-4">CREATE PURCHASE REQUEST</h1>  
          </div>
          <form action="{% url 'requester' %}" method="post">
            {% csrf_token %}
            <div class="row w-100 m-auto"> 
              <div class="col-12 col-sm-12 col-md-6 col-lg-4 ps-0">
                <div class="form-group mb-3">
                  <label for="departmentDropdown">Choose Department:</label>
                  <select class="form-control" id="departmentDropdown" name="departmentDropdown">
                      <option value="option1">College of Arts and Sciences</option>
                      <option value="option2">College of Agriculture</option>
                      <option value="option3">College of Forestry</option>
                      <option value="option4">College of Hospitality Management and Tourism</option>
                      <option value="option5">College of Technology and Engineering</option>
                      <option value="option6">College of Education</option>
                      <option value="option7">Graduate School</option>
                      <option value="option8">  Others please specify:</option>
                  </select>
                </div>
              </div>

              <div class="col-12 col-sm-12 col-md-6 col-lg-4 ps-0">
                <div class="form-group mb-3">
                  <label for="exampleFormcontrolTextarea1 p-2">Purpose</label>
                  <textarea class="form-control" id="exampleFormcontrolTextarea1" name="item_purpose" rows="1"></textarea>
                </div>
              </div>
            
            </div> 

            <div class="row w-100 m-auto mb-3">
              <div class="col-6 col-sm-6 col-md-7 col-lg-9">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                  Select Items
                </button>

                <!-- Modal -->
                <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">New Request</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="form-group mb-1">
                          <label for="exampleFormcontrolTextarea1 p-2">Item Name</label>
                          <input type="text" class="form-control item-name" name="item_name[]">
                        </div>
                        <div class="form-group mb-1">
                          <label for="exampleFormcontrolTextarea1 p-2">Item Description</label>
                          <textarea class="form-control item-description" name="item_description[]" rows="1"></textarea>
                        </div>
                        <div class="form-group mb-1">
                          <label for="exampleFormcontrolTextarea1 p-2">Unit</label>
                          <input type="text" class="form-control unit" name="unit[]">
                        </div>
                        <div class="form-group mb-1">
                          <label for="exampleFormcontrolTextarea1 p-2">Quantity</label>
                          <input type="number" class="form-control quantity" min="1" oninput="calculateRowTotal(this)" name="quantity[]">
                        </div>
                        <div class="form-group mb-1">
                          <label for="exampleFormcontrolTextarea1 p-2">Unit Cost</label>
                          <input type="number" class="form-control unit-cost" name="unit_cost[]" min="00.00" step="00.00" oninput="calculateRowTotal(this)">
                        </div>
                        
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary">Add</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-6 col-sm-6 col-md-5 col-lg-3">
                <input class="form-control" type="text" placeholder="Search"  id="search_bar_request">
              </div>
            </div>
            <div class="table-responsive">

              <table class="table" id="create_request_table" style="border: 1px solid black;">
                <thead>
                    <tr>
                        <th class="">Item No.</th>
                        <th class="">Item Name</th>
                        <th class="">Item Brand/Description</th>
                        <th class="">Unit</th>
                        <th class="">Unit Cost</th>
                        <th class="">Quantity</th>
                        <th class="">Total Price</th>
                    </tr>
                </thead>
                <tbody>
                  <tr class="item-row" style="display: none;">
                    <td style="text-align: center;"><span class="item-no">1</span></td>
                    <td><input type="text" class="item-name" name="item_name[]"></td>
                    <td><input type="text" class="item-description" name="item_description[]"></td>
                    <td><input type="text" class="unit" name="unit[]"></td>
                    <td><input type="number" class="unit-cost" name="unit_cost[]" min="00.00" step="00.00" oninput="calculateRowTotal(this)"></td>
                    <td><input type="number" class="quantity" min="1" oninput="calculateRowTotal(this)" name="quantity[]"></td>
                    <td><span class="total">00.00</span></td>
                  </tr>
                </tbody>
                 <tfoot>
    <tr>
      <td colspan="6">Total Amount</td>
      <td><span id="totalAmount">00.00</span></td>
    </tr>
  </tfoot>
            </table>
          </div>
        <div class="text-start my-2 mx-5 mt-0" style=" display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-between;">
          <button type="button" class="btn btn-info text-white add-new"><i class="fa fa-plus"></i> Item</button>
          
        </div>
        <div 
          class="container justify-content-end align-items-baseline">
          <input class="btn btn-primary" type="submit" value="Submit">
          </div>
        
            <!-- Confirmation pop-up -->
            <div id="confirmationPopup" class="popup">
              <span class="popup-close" onclick="hideConfirmationPopup()">X</span>
              <h2>Purchase Request Confirmation</h2>
              <!-- Add your confirmation content here -->
              <p>Your purchase request has been submitted and is being processed.</p>
            </div>
         </div>
          
        </div>
        
      </form>
      </div>
    </div> 
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const itemTable = document.getElementById('itemTable');
    const addButton = document.querySelector('.add-new');
    let itemNumber = 1; // Initialize item number

    addButton.addEventListener('click', function () {
        const newRow = itemTable.querySelector('.item-row').cloneNode(true);
        const itemNumberSpan = newRow.querySelector('.item-no');
        itemNumberSpan.textContent = itemNumber;
        itemNumber++;

        itemTable.querySelector('tbody').appendChild(newRow);
        newRow.style.display = 'table-row'; // Show the new row
    });

    // Calculate the total amount
    const calculateTotal = function () {
        let totalAmount = 0;
        const quantityInputs = document.querySelectorAll('.quantity');
        const priceInputs = document.querySelectorAll('.unit_cost');

        for (let i = 0; i < quantityInputs.length; i++) {
            const quantity = parseFloat(quantityInputs[i].value) || 0;
            const price = parseFloat(priceInputs[i].value) || 0;
            totalAmount += quantity * price;
        }

        const totalAmountSpan = document.getElementById('totalAmountSpan');
        totalAmountSpan.textContent = totalAmount.toFixed(2);
    };

    // Attach input event listeners to quantity and price inputs
    const quantityInputs = document.querySelectorAll('.quantity');
    const priceInputs = document.querySelectorAll('.unit_cost');

    quantityInputs.forEach(input => {
        input.addEventListener('input', calculateTotal);
    });

    priceInputs.forEach(input => {
        input.addEventListener('input', calculateTotal);
    });

    // Trigger the initial calculation
    calculateTotal();

    // Update department name in the hidden input field
    const departmentDropdown = document.getElementById('departmentDropdown');
    departmentDropdown.addEventListener("change", function () {
        const selectedOption = departmentDropdown.options[departmentDropdown.selectedIndex];
        const selectedOptionText = selectedOption.textContent;
        const selectedDepartmentNameInput = document.getElementById('selectedDepartmentName');
        selectedDepartmentNameInput.value = selectedOptionText;
    });

    // Show/hide confirmation popup functions (if needed)
    function showConfirmationPopup() {
        document.getElementById('confirmationPopup').style.display = 'block';
    }

    function hideConfirmationPopup() {
        document.getElementById('confirmationPopup').style.display = 'none';
    }
});

    </script>
    
    
    <script>
      function calculateRowTotal(input) {
        const row = input.parentNode.parentNode;
        const unit_cost = parseFloat(row.querySelector('.unit-cost').value) || 0;
        const quantity = parseInt(row.querySelector('.quantity').value) || 0;
    
        const totalAmount = unit_cost * quantity;
        row.querySelector('.total').textContent = totalAmount.toFixed(2);
    
        calculateTotalAmount();
      }
    
      function calculateTotalAmount() {
        const totalElements = document.querySelectorAll('.total');
        let totalAmount = 0;
    
        totalElements.forEach(element => {
          totalAmount += parseFloat(element.textContent);
        });
    
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
      }
    </script>

<script>
  function showConfirmationPopup() {
    document.getElementById('confirmationPopup').style.display = 'block';
  }

  function hideConfirmationPopup() {
    document.getElementById('confirmationPopup').style.display = 'none';
  }
</script>

{% endblock %}  
  
