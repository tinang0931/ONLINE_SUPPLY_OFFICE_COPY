{% extends "accounts/User/main2.html" %}

{% load static %}

{% block ppmp %}

<div class="ppmp">
    <div class="ppmp-button">
        <ul>
            <li><a href="{% url 'catalogue' %}">Catalogue</a></li>
            <li><a href="">2024 PPMP</a></li>
        </ul>
    </div>

    <div class="ppmp-form">
        <form id="ppmpForm" action="" method="post">
            <div class="form-row">
                <select id="yearDropdown">
                    <option selected>Select Year</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <input type="hidden" id="selectedYear" name="selectedYear">
                <div class="ppmp-budget">
                    <h2>Total Allocated Budget:</h2>
                    <span id="total_allocated_budget">
                        <input name="estimate_budget" id="estimate_budget" readonly>
                    </span>
                </div>
            </div>                     
    
            <div class="table-responsive">
                <table class="ppmp-table">
                    <thead>
                        <tr>
                            <th rowspan='2' class="text-center">Item Name</th>
                            <th rowspan='2' class="text-center">Brand / Description</th>
                            <th rowspan='2' class="text-center">Unit</th>
                            <th rowspan='2' class="text-center">Estimated Budget</th>
                            <th colspan="12" class="text-center">Monthly Quantity Requirement</th>
                            <th rowspan='2' class="text-center">Unit Price</th>
                            <th rowspan="2" class="text-center">Action</th>
                        </tr>
                        <tr>
                            <th>Jan</th>
                            <th>Feb</th>
                            <th>Mar</th>
                            <th>April</th>
                            <th>May</th>
                            <th>June</th>
                            <th>July</th>
                            <th>Aug</th>
                            <th>Sept</th>
                            <th>Oct</th>
                            <th>Nov</th>
                            <th>Dec</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- Data will be inserted dynamically here -->
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    
    <!-- Fixed Footer -->
    <div class="total-footer">
        <label for="estimate_budget" style="margin-right: 10px;">
            <strong>TOTAL BUDGET :</strong>
        </label>
        <input type="number"  readonly>
        <div class="submit-button">
        <button type="button" id="submitBtn">Submit</button>
        </div>
    </div>


<script>
    // Function to fetch data from the PPMPView API and populate the table
    async function fetchDataAndPopulateTable() {
        try {
            const token = localStorage.getItem('accessToken'); // Get the token for authentication

            if (!token) {
                alert("User is not logged in. Please log in.");
                return;
            }

            // Replace with your actual API URL for PPMPView
            const apiUrl = 'http://172.28.51.194:8000/api/ppmp/';

            // Fetch the data from the API
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            });

            // Check if the response is OK (status 200)
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            // Parse the JSON data returned from the API
            const data = await response.json();

            // Get the user's budget
            const userBudget = data.budget;

            // Format the number as Philippine Peso (â‚±) with commas as thousands separators
            const formattedBudget = new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP'
            }).format(userBudget);
            
            document.getElementById('estimate_budget').value = formattedBudget; // Display formatted budget
            

            // Get the table body element where data will be inserted
            const tableBody = document.getElementById('items-table-body');

            // Clear any existing rows before adding new ones
            tableBody.innerHTML = '';

            // Loop through the purchase items and create table rows dynamically
            data.purchase.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('item-row');
                row.id = `item-${item.id}`;

                // Create and populate table cells with item data
                row.innerHTML = `
                   
                    <td class="text-left">
                        <span class="editable" data-field="Item_name">${item.item}</span>
                        <input id="item_${item.id}" name="item" type="text" value="${item.item}" oninput="change_val('item_${item.id}')" class="edit-input" style="display: none">
                    </td>
                    <td class="text-left">
                        <span class="editable" data-field="Item_Brand">${item.item_brand_description}</span>
                        <input id="item_brand_${item.id}" name="item_brand" type="text" value="${item.item_brand_description}" oninput="change_val('item_brand_${item.id}')" class="edit-input" style="display: none">
                    </td>
                    <td class="text-left">
                        <span class="editable" data-field="Unit">${item.unit}</span>
                        <input id="unit_${item.id}" name="unit" type="text" value="${item.unit}" oninput="change_val('unit_${item.id}')" class="edit-input" style="display: none">
                    </td>
                    <td><input type="number" name="estimate_budget" value="${item.estimate_budget || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="jan" value="${item.jan || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="feb" value="${item.feb || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="mar" value="${item.mar || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="apr" value="${item.apr || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="may" value="${item.may || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="jun" value="${item.jun || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="jul" value="${item.jul || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="aug" value="${item.aug || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="sep" value="${item.sep || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="oct" value="${item.oct || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="nov" value="${item.nov || 0}"></td>
                    <td><input type="number" style="width: 38px;" name="dec" value="${item.dec || 0}"></td>
                    <td>
                        <span class="editable" data-field="Price">${item.unit_cost}</span>
                        <input id="price_${item.id}" name="price" type="number" value="${item.unit_cost}" oninput="change_val('price_${item.id}')" class="edit-input" style="display: none">
                    </td>
                    <td>
                        <div class="item-actions" style="margin-left: 17px;">
                            <a href="#" class="delete-icon delete-item" data-id="${item.id}">
                                <i class="fas fa-trash text-danger"></i>
                            </a>
                        </div>
                    </td>
                `;

                // Append the newly created row to the table body
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Call the function to fetch and display data when the page loads
    document.addEventListener('DOMContentLoaded', fetchDataAndPopulateTable);

    document.getElementById('submitBtn').addEventListener('click', async function() {
        const selectedYear = document.getElementById('yearDropdown').value;
        const totalBudget = document.getElementById('estimate_budget').value;
    
        // Check if the selected year is empty
        if (!selectedYear) {
            alert("Please select a year.");
            return;
        }
    
        // Initialize arrays to store form data
        const items = [];
        const itemBrands = [];
        const units = [];
        const unitCosts = [];
        const months = {
            'jan': [], 'feb': [], 'mar': [], 'apr': [], 'may': [], 'jun': [],
            'jul': [], 'aug': [], 'sep': [], 'oct': [], 'nov': [], 'dec': []
        };
    
        // Gather data from each row in the table
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            const itemName = row.querySelector('input[name="item"]').value.trim();
            const itemBrand = row.querySelector('input[name="item_brand"]').value.trim();
            const unit = row.querySelector('input[name="unit"]').value.trim();
            const unitCost = row.querySelector('input[name="price"]').value.trim();
    
            if (!itemName || !itemBrand || !unit || !unitCost) {
                alert("All fields must be filled out.");
                return;
            }
    
            // Create an object with the monthly quantities
            const monthValues = {
                'jan': row.querySelector('input[name="jan"]').value,
                'feb': row.querySelector('input[name="feb"]').value,
                'mar': row.querySelector('input[name="mar"]').value,
                'apr': row.querySelector('input[name="apr"]').value,
                'may': row.querySelector('input[name="may"]').value,
                'jun': row.querySelector('input[name="jun"]').value,
                'jul': row.querySelector('input[name="jul"]').value,
                'aug': row.querySelector('input[name="aug"]').value,
                'sep': row.querySelector('input[name="sep"]').value,
                'oct': row.querySelector('input[name="oct"]').value,
                'nov': row.querySelector('input[name="nov"]').value,
                'dec': row.querySelector('input[name="dec"]').value
            };
    
            // Push the item data into respective arrays
            items.push(itemName);
            itemBrands.push(itemBrand);
            units.push(unit);
            unitCosts.push(unitCost);
    
            // Add monthly values to the months object
            for (const month in months) {
                months[month].push(monthValues[month] || '');  // Use empty string for missing values
            }
        });
    
        // Ensure there is at least one valid row
        if (items.length === 0) {
            alert("Please add at least one item.");
            return;
        }
    
        // Prepare the payload
        const data = {
            selectedYear,
            item: items,
            item_brand_description: itemBrands,
            unit: units,
            unit_cost: unitCosts,
            jan: months.jan,
            feb: months.feb,
            mar: months.mar,
            apr: months.apr,
            may: months.may,
            jun: months.jun,
            jul: months.jul,
            aug: months.aug,
            sep: months.sep,
            oct: months.oct,
            nov: months.nov,
            dec: months.dec
        };
    

        const token = localStorage.getItem('accessToken');
        const apiUrl = 'http://172.28.51.194:8000/api/newcheckout/';
    
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(data)
            });
    
            const result = await response.json();
    
            // Handle the response from the API
            if (response.ok) {
                alert("Data submitted successfully!");
                location.reload(); // Reload the page to reset form (optional)
            } else {
                alert(`Error: ${result.error || 'Something went wrong.'}`);
            }
        } catch (error) {
            console.error('Error submitting data:', error);
            alert('Failed to submit the data.');
        }
    });
    
</script>



{% endblock %}